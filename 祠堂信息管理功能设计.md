# 祠堂信息管理功能设计

## 1. 功能概述

祠堂信息管理是中国族谱的重要组成部分，用于管理宗族祠堂的基本信息、历史、活动和相关记录。该功能允许管理员创建和维护祠堂信息，包括祠堂基本信息、历史记录、活动记录等。

## 2. 数据模型设计

### 2.1 自定义GEDCOM标签

- **`_ANCESTRAL_HALL`**：存储祠堂信息
  - 属性：
    - `NAME`：祠堂名称
    - `DESC`：祠堂描述
    - `LOC`：祠堂位置
    - `BUILT_DATE`：建造日期
    - `HISTORY`：祠堂历史
    - `PHOTO`：祠堂照片
    - `ACTIVITIES`：活动记录

- **`_HALL_ACTIVITY`**：存储祠堂活动记录
  - 属性：
    - `HALL`：所属祠堂
    - `TYPE`：活动类型
    - `DATE`：活动日期
    - `LOC`：活动地点
    - `DESC`：活动描述
    - `PARTICIPANTS`：参与者

### 2.2 数据库扩展

- 创建`ancestral_halls`表，用于存储祠堂基本信息
  - `ah_id`：主键
  - `ah_tree_id`：所属家谱树
  - `ah_name`：祠堂名称
  - `ah_desc`：祠堂描述
  - `ah_location`：祠堂位置
  - `ah_built_date`：建造日期
  - `ah_history`：祠堂历史
  - `ah_photo`：祠堂照片（路径或URL）
  - `ah_created_at`：创建时间
  - `ah_updated_at`：更新时间

- 创建`hall_activities`表，用于存储祠堂活动记录
  - `ha_id`：主键
  - `ha_hall_id`：所属祠堂
  - `ha_type`：活动类型
  - `ha_date`：活动日期
  - `ha_location`：活动地点
  - `ha_description`：活动描述
  - `ha_participants`：参与者（JSON格式）
  - `ha_created_at`：创建时间
  - `ha_updated_at`：更新时间

- 创建`hall_photos`表，用于存储祠堂照片
  - `hp_id`：主键
  - `hp_hall_id`：所属祠堂
  - `hp_photo_path`：照片路径
  - `hp_photo_name`：照片名称
  - `hp_description`：照片描述
  - `hp_uploaded_at`：上传时间

## 3. 核心功能实现

### 3.1 祠堂基本信息管理

- 支持创建、编辑、删除祠堂
- 支持设置祠堂名称、描述、位置、建造日期等基本信息
- 支持添加和管理祠堂历史
- 支持上传和管理祠堂照片
- 支持搜索和筛选祠堂

### 3.2 祠堂活动管理

- 支持创建、编辑、删除祠堂活动
- 支持设置活动类型、日期、地点、描述等信息
- 支持添加和管理活动参与者
- 支持活动日历视图
- 支持活动统计和分析

### 3.3 祠堂照片管理

- 支持上传和删除祠堂照片
- 支持设置照片描述和标签
- 支持照片分类和筛选
- 支持照片库展示

### 3.4 祠堂详情展示

- 支持祠堂详情页面展示
- 支持祠堂照片画廊
- 支持祠堂活动列表
- 支持祠堂地图展示

## 4. 界面设计

### 4.1 祠堂管理页面

- 祠堂列表展示
- 祠堂创建和编辑表单
- 祠堂详情查看
- 活动管理入口
- 照片管理入口

### 4.2 祠堂详情页面

- 祠堂基本信息展示
- 祠堂历史记录
- 祠堂照片画廊
- 祠堂活动列表
- 祠堂地图

### 4.3 活动管理页面

- 活动列表展示
- 活动创建和编辑表单
- 活动日历视图
- 活动参与者管理

### 4.4 照片管理页面

- 照片库展示
- 照片上传功能
- 照片编辑功能
- 照片分类和筛选

## 5. 技术实现

### 5.1 模块设计

- 创建`AncestralHallModule`模块，实现祠堂信息管理功能
- 继承`AbstractModule`类
- 实现必要的模块接口

### 5.2 数据访问

- 使用现有的数据库连接
- 实现祠堂相关的数据访问层
- 支持事务处理

### 5.3 业务逻辑

- 实现祠堂信息管理的核心逻辑
- 支持权限控制
- 支持数据验证

### 5.4 界面实现

- 使用现有的模板系统
- 实现响应式设计
- 集成中国传统风格
- 支持地图展示（可集成百度地图或高德地图）

## 6. 与现有功能集成

### 6.1 宗族管理集成

- 支持将祠堂与宗族关联
- 支持从宗族页面访问祠堂信息
- 支持在祠堂页面显示关联宗族

### 6.2 活动管理集成

- 支持将祠堂活动与宗族活动关联
- 支持在活动页面显示关联祠堂

### 6.3 媒体管理集成

- 支持与现有媒体管理功能集成
- 支持共享媒体文件

## 7. 性能优化

- 实现数据缓存
- 优化数据库查询
- 实现分页加载
- 优化照片上传和展示性能

## 8. 安全考虑

- 实现输入验证
- 防止SQL注入
- 实现权限控制
- 保护敏感数据
- 安全处理照片上传

## 9. 测试计划

### 9.1 单元测试

- 测试数据模型
- 测试业务逻辑
- 测试数据访问层

### 9.2 集成测试

- 测试与现有功能的集成
- 测试权限系统
- 测试搜索功能

### 9.3 系统测试

- 测试完整的祠堂管理流程
- 测试照片上传和展示
- 测试活动管理功能

## 10. 部署计划

### 10.1 数据库迁移

- 创建必要的数据库表
- 实现数据迁移脚本
- 支持回滚功能

### 10.2 模块部署

- 将模块文件复制到相应目录
- 运行数据库迁移
- 配置权限
- 测试功能

## 11. 后续扩展

- 支持祠堂3D模型展示
- 支持祠堂虚拟参观
- 支持祠堂文物管理
- 支持祠堂祭祀流程管理

## 12. 技术栈

- PHP 7.3+
- MySQL/PostgreSQL/SQLite
- webtrees 2.2.4
- 遵循PSR标准
- 使用现有的模块化架构
