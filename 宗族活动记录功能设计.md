# 宗族活动记录功能设计

## 1. 功能概述

宗族活动记录是中国族谱的重要组成部分，用于管理宗族组织的各类活动，包括祭祀、聚会、庆典、修缮等。该功能允许管理员创建和维护宗族活动记录，包括活动基本信息、参与者、照片和相关文档。

## 2. 数据模型设计

### 2.1 自定义GEDCOM标签

- **`_CLAN_ACTIVITY`**：存储宗族活动记录
  - 属性：
    - `NAME`：活动名称
    - `TYPE`：活动类型
    - `DATE`：活动日期
    - `LOC`：活动地点
    - `DESC`：活动描述
    - `ORGANIZER`：组织者
    - `PARTICIPANTS`：参与者列表
    - `PHOTOS`：活动照片
    - `DOCS`：相关文档

- **`_ACTIVITY_PARTICIPANT`**：存储活动参与者信息
  - 属性：
    - `ACTIVITY`：所属活动
    - `INDIVIDUAL`：参与者（指向INDI记录）
    - `ROLE`：参与者角色
    - `STATUS`：参与状态

### 2.2 数据库扩展

- 创建`clan_activities`表，用于存储宗族活动基本信息
  - `ca_id`：主键
  - `ca_tree_id`：所属家谱树
  - `ca_clan_id`：所属宗族
  - `ca_name`：活动名称
  - `ca_type`：活动类型
  - `ca_date`：活动日期
  - `ca_location`：活动地点
  - `ca_description`：活动描述
  - `ca_organizer`：组织者（指向INDI记录）
  - `ca_created_at`：创建时间
  - `ca_updated_at`：更新时间

- 创建`activity_participants`表，用于存储活动参与者信息
  - `ap_id`：主键
  - `ap_activity_id`：所属活动
  - `ap_individual_id`：参与者ID（指向INDI记录）
  - `ap_role`：参与者角色
  - `ap_status`：参与状态（已确认、已拒绝、待定）
  - `ap_created_at`：创建时间

- 创建`activity_photos`表，用于存储活动照片
  - `apho_id`：主键
  - `apho_activity_id`：所属活动
  - `apho_photo_path`：照片路径
  - `apho_photo_name`：照片名称
  - `apho_description`：照片描述
  - `apho_uploaded_at`：上传时间

- 创建`activity_docs`表，用于存储活动相关文档
  - `adoc_id`：主键
  - `adoc_activity_id`：所属活动
  - `adoc_doc_path`：文档路径
  - `adoc_doc_name`：文档名称
  - `adoc_description`：文档描述
  - `adoc_uploaded_at`：上传时间

## 3. 核心功能实现

### 3.1 活动管理

- 支持创建、编辑、删除活动
- 支持设置活动类型、日期、地点、描述等信息
- 支持设置活动组织者
- 支持搜索和筛选活动

### 3.2 参与者管理

- 支持添加和删除活动参与者
- 支持设置参与者角色
- 支持管理参与者状态
- 支持批量管理参与者

### 3.3 媒体管理

- 支持上传和删除活动照片
- 支持上传和删除活动文档
- 支持设置照片和文档描述
- 支持媒体文件分类和筛选

### 3.4 活动日历

- 支持活动日历视图展示
- 支持按月份、季度、年度查看活动
- 支持活动提醒功能
- 支持从日历创建活动

### 3.5 活动统计

- 支持活动类型统计
- 支持参与者统计
- 支持活动频率统计
- 支持生成活动统计报告

## 4. 界面设计

### 4.1 活动管理页面

- 活动列表展示
- 活动创建和编辑表单
- 活动详情查看
- 参与者管理入口
- 媒体管理入口

### 4.2 活动详情页面

- 活动基本信息展示
- 参与者列表
- 活动照片画廊
- 活动文档列表

### 4.3 参与者管理页面

- 参与者列表展示
- 参与者添加和编辑表单
- 参与者状态管理
- 参与者批量操作

### 4.4 活动日历页面

- 日历视图展示
- 活动创建功能
- 活动详情查看
- 活动筛选功能

## 5. 技术实现

### 5.1 模块设计

- 创建`ClanActivityModule`模块，实现宗族活动记录功能
- 继承`AbstractModule`类
- 实现必要的模块接口

### 5.2 数据访问

- 使用现有的数据库连接
- 实现活动相关的数据访问层
- 支持事务处理

### 5.3 业务逻辑

- 实现宗族活动管理的核心逻辑
- 支持权限控制
- 支持数据验证

### 5.4 界面实现

- 使用现有的模板系统
- 实现响应式设计
- 集成中国传统风格
- 支持日历组件

## 6. 与现有功能集成

### 6.1 宗族管理集成

- 支持将活动与宗族关联
- 支持从宗族页面访问活动信息
- 支持在活动页面显示关联宗族

### 6.2 祠堂管理集成

- 支持将活动与祠堂关联
- 支持从祠堂页面访问活动信息
- 支持在活动页面显示关联祠堂

### 6.3 人员管理集成

- 支持从人员页面查看参与的活动
- 支持在活动页面直接添加人员为参与者

### 6.4 媒体管理集成

- 支持与现有媒体管理功能集成
- 支持共享媒体文件

## 7. 性能优化

- 实现数据缓存
- 优化数据库查询
- 实现分页加载
- 优化媒体文件上传和展示性能

## 8. 安全考虑

- 实现输入验证
- 防止SQL注入
- 实现权限控制
- 保护敏感数据
- 安全处理媒体文件上传

## 9. 测试计划

### 9.1 单元测试

- 测试数据模型
- 测试业务逻辑
- 测试数据访问层

### 9.2 集成测试

- 测试与现有功能的集成
- 测试权限系统
- 测试搜索功能

### 9.3 系统测试

- 测试完整的活动管理流程
- 测试参与者管理功能
- 测试媒体文件上传和展示
- 测试活动日历功能

## 10. 部署计划

### 10.1 数据库迁移

- 创建必要的数据库表
- 实现数据迁移脚本
- 支持回滚功能

### 10.2 模块部署

- 将模块文件复制到相应目录
- 运行数据库迁移
- 配置权限
- 测试功能

## 11. 后续扩展

- 支持活动报名功能
- 支持活动评论和分享
- 支持活动直播功能
- 支持活动经费管理

## 12. 技术栈

- PHP 7.3+
- MySQL/PostgreSQL/SQLite
- webtrees 2.2.4
- 遵循PSR标准
- 使用现有的模块化架构
