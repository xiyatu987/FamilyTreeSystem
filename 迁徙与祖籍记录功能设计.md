# 迁徙与祖籍记录功能设计

## 1. 功能概述

迁徙与祖籍记录是中国族谱的重要组成部分，用于管理宗族和个人的祖籍信息、迁徙历史和当前所在地。该功能允许管理员创建和维护迁徙与祖籍记录，包括祖籍信息、迁徙路线、迁徙历史等。

## 2. 数据模型设计

### 2.1 自定义GEDCOM标签

- **`_ANCESTRAL_HOME`**：存储祖籍信息
  - 属性：
    - `NAME`：祖籍名称
    - `LOC`：祖籍位置
    - `DESC`：祖籍描述
    - `HISTORY`：祖籍历史

- **`_MIGRATION`**：存储迁徙记录
  - 属性：
    - `FROM`：出发地
    - `TO`：目的地
    - `DATE`：迁徙日期
    - `REASON`：迁徙原因
    - `DESC`：迁徙描述
    - `ROUTE`：迁徙路线

- **`_CURRENT_LOC`**：存储当前所在地信息
  - 属性：
    - `NAME`：地点名称
    - `LOC`：地点位置
    - `DATE`：定居日期
    - `DESC`：定居描述

### 2.2 数据库扩展

- 创建`ancestral_homes`表，用于存储祖籍信息
  - `ah_id`：主键
  - `ah_tree_id`：所属家谱树
  - `ah_clan_id`：所属宗族
  - `ah_name`：祖籍名称
  - `ah_location`：祖籍位置
  - `ah_description`：祖籍描述
  - `ah_history`：祖籍历史
  - `ah_created_at`：创建时间
  - `ah_updated_at`：更新时间

- 创建`migrations`表，用于存储迁徙记录
  - `m_id`：主键
  - `m_tree_id`：所属家谱树
  - `m_individual_id`：所属人员（可为空，代表宗族迁徙）
  - `m_clan_id`：所属宗族
  - `m_from_location`：出发地
  - `m_to_location`：目的地
  - `m_date`：迁徙日期
  - `m_reason`：迁徙原因
  - `m_description`：迁徙描述
  - `m_route`：迁徙路线
  - `m_created_at`：创建时间
  - `m_updated_at`：更新时间

- 创建`current_locations`表，用于存储当前所在地信息
  - `cl_id`：主键
  - `cl_tree_id`：所属家谱树
  - `cl_individual_id`：所属人员
  - `cl_clan_id`：所属宗族
  - `cl_name`：地点名称
  - `cl_location`：地点位置
  - `cl_settled_date`：定居日期
  - `cl_description`：定居描述
  - `cl_created_at`：创建时间
  - `cl_updated_at`：更新时间

## 3. 核心功能实现

### 3.1 祖籍管理

- 支持创建、编辑、删除祖籍信息
- 支持设置祖籍名称、位置、描述和历史
- 支持搜索和筛选祖籍

### 3.2 迁徙记录管理

- 支持创建、编辑、删除迁徙记录
- 支持设置迁徙出发地、目的地、日期、原因和描述
- 支持设置迁徙路线
- 支持按时间顺序展示迁徙历史

### 3.3 当前所在地管理

- 支持设置和更新当前所在地信息
- 支持设置定居日期和描述
- 支持搜索和筛选当前所在地

### 3.4 迁徙地图展示

- 支持迁徙路线地图展示
- 支持集成地图服务（百度地图或高德地图）
- 支持交互式地图操作
- 支持地图上标注迁徙节点

### 3.5 迁徙历史查询

- 支持按人员查询迁徙历史
- 支持按宗族查询迁徙历史
- 支持按时间范围查询迁徙记录
- 支持迁徙历史可视化展示

## 4. 界面设计

### 4.1 祖籍管理页面

- 祖籍列表展示
- 祖籍创建和编辑表单
- 祖籍详情查看

### 4.2 迁徙记录页面

- 迁徙记录列表展示
- 迁徙记录创建和编辑表单
- 迁徙详情查看
- 迁徙地图展示

### 4.3 当前所在地页面

- 当前所在地列表展示
- 当前所在地设置和编辑表单

### 4.4 迁徙地图页面

- 交互式地图展示
- 迁徙路线标注
- 迁徙节点信息展示
- 地图缩放和导航

## 5. 技术实现

### 5.1 模块设计

- 创建`MigrationModule`模块，实现迁徙与祖籍记录功能
- 继承`AbstractModule`类
- 实现必要的模块接口

### 5.2 数据访问

- 使用现有的数据库连接
- 实现迁徙与祖籍相关的数据访问层
- 支持事务处理

### 5.3 业务逻辑

- 实现迁徙与祖籍管理的核心逻辑
- 支持权限控制
- 支持数据验证

### 5.4 界面实现

- 使用现有的模板系统
- 实现响应式设计
- 集成中国传统风格
- 支持地图展示（可集成百度地图或高德地图）

## 6. 与现有功能集成

### 6.1 宗族管理集成

- 支持将祖籍与宗族关联
- 支持将迁徙记录与宗族关联
- 支持从宗族页面访问迁徙与祖籍信息

### 6.2 人员管理集成

- 支持将迁徙记录与人员关联
- 支持从人员页面访问迁徙历史
- 支持在人员页面显示当前所在地

### 6.3 地图服务集成

- 支持集成第三方地图服务
- 支持地图上展示迁徙路线
- 支持地图上展示地点信息

## 7. 性能优化

- 实现数据缓存
- 优化数据库查询
- 实现分页加载
- 优化地图渲染性能

## 8. 安全考虑

- 实现输入验证
- 防止SQL注入
- 实现权限控制
- 保护敏感数据

## 9. 测试计划

### 9.1 单元测试

- 测试数据模型
- 测试业务逻辑
- 测试数据访问层

### 9.2 集成测试

- 测试与现有功能的集成
- 测试权限系统
- 测试搜索功能

### 9.3 系统测试

- 测试完整的迁徙与祖籍管理流程
- 测试迁徙地图展示
- 测试迁徙历史查询

## 10. 部署计划

### 10.1 数据库迁移

- 创建必要的数据库表
- 实现数据迁移脚本
- 支持回滚功能

### 10.2 模块部署

- 将模块文件复制到相应目录
- 运行数据库迁移
- 配置权限
- 测试功能

## 11. 后续扩展

- 支持迁徙原因分析
- 支持迁徙统计功能
- 支持迁徙路线优化
- 支持迁徙影响分析

## 12. 技术栈

- PHP 7.3+
- MySQL/PostgreSQL/SQLite
- webtrees 2.2.4
- 遵循PSR标准
- 使用现有的模块化架构
