# 族谱管理开发文档

## 1. 项目概述

中国族谱管理系统是一个基于 Laravel 框架开发的独立在线族谱管理系统，专门针对中国家族文化特点设计，支持中式亲属关系计算、字辈管理、祠堂管理、迁徙记录等特色功能。

### 1.1 核心功能
- 家族成员信息管理
- 中式亲属关系计算
- 字辈管理与谱系图
- 祠堂信息管理
- 迁徙记录与地图可视化
- 墓地信息管理
- 家规家训管理
- 宗族组织结构管理
- 宗族活动记录

### 1.2 技术栈
- PHP 8.0+
- Laravel 9.x
- MySQL 8.0+
- Blade 模板引擎
- Bootstrap 5
- jQuery
- Chart.js
- Font Awesome
- Composer 管理 PHP 依赖
- npm 管理前端依赖

## 2. 项目结构

### 2.1 核心目录
- **app/**：应用程序核心代码（Models、Controllers、Services等）
- **bootstrap/**：框架启动文件
- **config/**：应用配置文件
- **database/**：数据库迁移、种子和工厂
- **public/**：公共资源入口
- **resources/**：视图、语言文件和前端资源
- **routes/**：路由定义
- **storage/**：文件存储目录
- **tests/**：测试文件
- **vendor/**：Composer依赖

### 2.2 核心实体类
| 类名 | 文件路径 | 描述 |
|------|----------|------|
| User | app/Models/User.php | 用户模型 |
| FamilyMember | app/Models/FamilyMember.php | 家族成员模型 |
| Ziwei | app/Models/Ziwei.php | 字辈模型 |
| Clan | app/Models/Clan.php | 宗族模型 |
| AncestralHall | app/Models/AncestralHall.php | 祠堂模型 |
| MigrationRecord | app/Models/MigrationRecord.php | 迁徙记录模型 |
| Grave | app/Models/Grave.php | 墓地模型 |
| FamilyRule | app/Models/FamilyRule.php | 家族规则模型 |
| ClanActivity | app/Models/ClanActivity.php | 宗族活动模型 |

## 3. 人员关系管理

### 3.1 核心概念
- **家族成员（FamilyMember）**：表示家谱中的一个人
- **亲属关系**：通过父亲ID、母亲ID和配偶ID建立的家族关系
- **辈份**：通过generation字段和字辈系统表示的家族世代关系

### 3.2 人员关系模型

#### 3.2.1 基本关系
- **父子/母子关系**：通过father_id和mother_id字段建立
- **配偶关系**：通过spouse_id字段建立
- **字辈关系**：通过ziwei_id字段与字辈系统关联
- **用户所属关系**：通过user_id字段确保数据隔离

#### 3.2.2 婚姻关系
- 支持一对一配偶关系
- 配偶信息通过spouse_id字段关联

#### 3.2.3 父母子女关系
- 子女通过father_id或mother_id字段关联到父母
- 支持单亲家庭结构

### 3.3 关系查询方法

| 方法 | 类 | 文件路径 | 描述 |
|------|----|----------|------|
| user() | FamilyMember | app/Models/FamilyMember.php | 获取关联的用户 |
| ziwei() | FamilyMember | app/Models/FamilyMember.php | 获取关联的字辈 |
| father() | FamilyMember | app/Models/FamilyMember.php | 获取父亲 |
| mother() | FamilyMember | app/Models/FamilyMember.php | 获取母亲 |
| spouse() | FamilyMember | app/Models/FamilyMember.php | 获取配偶 |
| children() | FamilyMember | app/Models/FamilyMember.php | 获取子女列表 |
| migrations() | FamilyMember | app/Models/FamilyMember.php | 获取迁徙记录 |
| grave() | FamilyMember | app/Models/FamilyMember.php | 获取墓地信息 |

## 4. 核心实体类属性

### 4.1 FamilyMember（家族成员）

#### 表结构
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | int | 主键ID |
| name | string | 姓名 |
| gender | string | 性别（male/female/other） |
| birth_date | date | 出生日期 |
| death_date | date | 去世日期 |
| birth_place | string | 出生地 |
| death_place | string | 去世地 |
| father_id | int | 父亲ID |
| mother_id | int | 母亲ID |
| spouse_id | int | 配偶ID |
| ziwei_id | int | 字辈ID |
| generation | int | 世代 |
| description | text | 描述 |
| user_id | int | 用户ID |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### 访问器
| 方法名 | 返回类型 | 描述 |
|--------|----------|------|
| getGenderDisplayAttribute() | string | 获取性别中文显示（男/女/其他） |
| getIsAliveAttribute() | bool | 判断是否在世（根据death_date是否为空） |

## 5. 核心服务

### 5.1 KinshipService（亲属关系计算服务）

#### 功能描述
- 计算中式亲属关系称谓
- 支持复杂的家族关系查询

#### 关键方法
| 方法名 | 参数 | 返回类型 | 描述 |
|--------|------|----------|------|
| getRelationship() | FamilyMember $subject, FamilyMember $object | string | 计算两个家族成员之间的亲属关系称谓 |
| isSpouse() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为配偶关系 |
| isParent() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为父母关系 |
| isChild() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为子女关系 |
| isSibling() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为兄弟姐妹关系 |
| isGrandparent() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为祖父母关系 |
| isGrandchild() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为孙子女关系 |
| isPaternalUncleOrAunt() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为父系叔伯姑关系 |
| isMaternalUncleOrAunt() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为母系舅姨关系 |
| isCousin() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为堂表兄弟姐妹关系 |
| isNephewOrNiece() | FamilyMember $subject, FamilyMember $object | bool | 判断是否为侄子侄女关系 |

## 6. 核心控制器

| 控制器名 | 文件路径 | 主要功能 |
|----------|----------|----------|
| AuthController | app/Http/Controllers/AuthController.php | 用户认证（登录、注册、退出） |
| FamilyMemberController | app/Http/Controllers/FamilyMemberController.php | 家族成员管理 |
| ZiweiController | app/Http/Controllers/ZiweiController.php | 字辈管理 |
| KinshipController | app/Http/Controllers/KinshipController.php | 亲属关系查询 |
| ClanController | app/Http/Controllers/ClanController.php | 宗族管理 |
| AncestralHallController | app/Http/Controllers/AncestralHallController.php | 祠堂管理 |
| MigrationController | app/Http/Controllers/MigrationController.php | 迁徙记录管理 |
| GraveController | app/Http/Controllers/GraveController.php | 墓地信息管理 |
| FamilyRuleController | app/Http/Controllers/FamilyRuleController.php | 家族规则管理 |
| ClanActivityController | app/Http/Controllers/ClanActivityController.php | 宗族活动管理 |
| AdminController | app/Http/Controllers/AdminController.php | 管理员功能 |

## 7. 主要路由

| 路由名称 | URI | 控制器方法 | 功能描述 | 访问权限 |
|----------|-----|------------|----------|----------|
| login | /login | AuthController@showLoginForm | 显示登录表单 | 公开 |
| login.post | /login | AuthController@login | 处理登录请求 | 公开 |
| register | /register | AuthController@showRegisterForm | 显示注册表单 | 公开 |
| register.post | /register | AuthController@register | 处理注册请求 | 公开 |
| logout | /logout | AuthController@logout | 用户退出 | 认证 |
| home | / | FamilyMemberController@index | 首页，显示家族成员列表 | 认证 |
| members.index | /members | FamilyMemberController@index | 家族成员列表 | 认证 |
| members.create | /members/create | FamilyMemberController@create | 创建家族成员表单 | 认证 |
| members.store | /members | FamilyMemberController@store | 保存新家族成员 | 认证 |
| members.show | /members/{id} | FamilyMemberController@show | 查看家族成员详情 | 认证 |
| members.edit | /members/{id}/edit | FamilyMemberController@edit | 编辑家族成员表单 | 认证 |
| members.update | /members/{id} | FamilyMemberController@update | 更新家族成员信息 | 认证 |
| members.destroy | /members/{id} | FamilyMemberController@destroy | 删除家族成员 | 认证 |
| tree | /tree | FamilyMemberController@tree | 家族树可视化 | 认证 |
| kinship | /kinship | KinshipController@index | 亲属关系查询 | 认证 |
| admin.dashboard | /admin | AdminController@index | 管理员仪表盘 | 管理员 |
| admin.users | /admin/users | AdminController@users | 用户管理 | 管理员 |

## 8. 开发与部署

### 8.1 开发环境设置
```bash
# 安装PHP依赖
composer install

# 安装前端依赖
npm install

# 配置环境变量
cp .env.example .env

# 生成应用密钥
php artisan key:generate

# 运行数据库迁移
php artisan migrate

# 启动开发服务器
php artisan serve
```

### 8.2 部署建议
- 使用Nginx或Apache作为Web服务器
- 配置SSL证书确保HTTPS访问
- 设置正确的文件权限
- 定期备份数据库和上传文件

## 9. 测试

### 9.1 单元测试
使用PHPUnit进行单元测试：
```bash
php artisan test
```

### 9.2 功能测试
- 家族成员的增删改查
- 亲属关系计算准确性
- 用户权限控制
- 系统启动与运行稳定性

## 10. 代码规范

### 10.1 PHP代码规范
- 遵循PSR-12编码标准
- 使用类型提示和返回类型声明
- 保持类和方法的单一职责原则

### 10.2 命名约定
- 类名：使用大驼峰命名法（如FamilyMemberController）
- 方法名：使用小驼峰命名法（如getRelationship）
- 变量名：使用小驼峰命名法（如familyMember）
- 常量名：使用全大写加下划线命名法（如MAX_UPLOAD_SIZE）

## 11. 安全注意事项

### 11.1 数据安全
- 使用Laravel的加密功能保护敏感数据
- 所有数据库密码和API密钥存储在环境变量中
- 定期备份数据库

### 11.2 访问控制
- 基于角色的权限管理
- 敏感操作需要身份验证
- 限制错误日志的详细程度

### 11.3 输入验证
- 使用Laravel的验证规则验证所有用户输入
- 防止SQL注入和XSS攻击
- 上传文件类型和大小限制

## 12. 未来扩展

### 12.1 功能扩展
- 移动端APP开发
- GEDCOM文件导入/导出功能
- 多语言支持
- 更多可视化图表和统计功能

### 12.2 技术扩展
- 使用Redis缓存提高性能
- 实现实时通知功能
- 添加API接口支持第三方集成
- 考虑使用Vue.js或React重构前端

## 13. 最佳实践

### 13.1 性能优化
- 使用缓存
- 优化数据库查询
- 限制返回结果数量

### 13.2 安全性
- 验证用户输入
- 使用参数化查询
- 实施适当的访问控制
- 保护敏感数据

## 14. 故障排除

### 14.1 常见问题
- **权限问题**：确保 storage/ 和 bootstrap/cache/ 目录可写
- **数据库连接问题**：检查 .env 文件中的配置
- **依赖安装问题**：确保PHP和Composer版本符合要求
- **性能问题**：优化数据库索引，检查服务器资源

### 14.2 日志
- 系统日志：查看 storage/logs/ 目录
- 错误日志：通过 .env 文件配置 APP_DEBUG 和 LOG_CHANNEL

