# 宗族组织结构管理功能设计

## 1. 功能概述

宗族组织结构管理是中国族谱的重要组成部分，用于管理宗族的层级结构、成员关系和组织信息。该功能允许管理员创建和维护宗族的组织结构，包括宗族分支、族长、成员等信息。

## 2. 数据模型设计

### 2.1 自定义GEDCOM标签

- **`_CLAN`**：存储宗族信息
  - 属性：
    - `NAME`：宗族名称
    - `DESC`：宗族描述
    - `LEADER`：宗族领袖
    - `BRANCH`：分支信息
    - `MEMBERS`：成员列表

- **`INDI:_CLAN_MEMBER`**：存储人员的宗族成员信息
  - 属性：
    - `CLAN`：所属宗族
    - `ROLE`：在宗族中的角色
    - `BRANCH`：所属分支
    - `JOIN_DATE`：加入日期

### 2.2 数据库扩展

- 创建`clans`表，用于存储宗族信息
  - `c_id`：主键
  - `c_tree_id`：所属家谱树
  - `c_name`：宗族名称
  - `c_desc`：宗族描述
  - `c_leader`：宗族领袖（指向INDI记录）
  - `c_created_at`：创建时间
  - `c_updated_at`：更新时间

- 创建`clan_branches`表，用于存储宗族分支信息
  - `cb_id`：主键
  - `cb_clan_id`：所属宗族
  - `cb_name`：分支名称
  - `cb_desc`：分支描述
  - `cb_leader`：分支领袖（指向INDI记录）
  - `cb_parent_id`：父分支ID

- 创建`clan_members`表，用于存储宗族成员信息
  - `cm_id`：主键
  - `cm_clan_id`：所属宗族
  - `cm_branch_id`：所属分支
  - `cm_individual_id`：人员ID（指向INDI记录）
  - `cm_role`：角色
  - `cm_join_date`：加入日期
  - `cm_status`：状态

## 3. 核心功能实现

### 3.1 宗族管理

- 支持创建、编辑、删除宗族
- 支持设置宗族领袖
- 支持添加和管理宗族描述
- 支持搜索和筛选宗族

### 3.2 分支管理

- 支持创建多级分支结构
- 支持设置分支领袖
- 支持添加分支描述
- 支持分支树状展示

### 3.3 成员管理

- 支持添加和删除宗族成员
- 支持设置成员角色
- 支持设置成员所属分支
- 支持批量管理成员

### 3.4 组织结构展示

- 支持宗族结构树状图展示
- 支持分支成员列表展示
- 支持成员角色筛选
- 支持导出组织结构

## 4. 界面设计

### 4.1 宗族管理页面

- 宗族列表展示
- 宗族创建和编辑表单
- 宗族详情查看
- 分支管理入口
- 成员管理入口

### 4.2 分支管理页面

- 分支树状图
- 分支创建和编辑表单
- 分支详情查看
- 分支成员列表

### 4.3 成员管理页面

- 成员列表展示
- 成员添加和编辑表单
- 成员角色管理
- 成员批量操作

### 4.4 组织结构图页面

- 宗族结构可视化展示
- 支持缩放和导航
- 支持点击查看详情
- 支持导出功能

## 5. 技术实现

### 5.1 模块设计

- 创建`ClanModule`模块，实现宗族管理功能
- 继承`AbstractModule`类
- 实现必要的模块接口

### 5.2 数据访问

- 使用现有的数据库连接
- 实现宗族相关的数据访问层
- 支持事务处理

### 5.3 业务逻辑

- 实现宗族结构管理的核心逻辑
- 支持权限控制
- 支持数据验证

### 5.4 界面实现

- 使用现有的模板系统
- 实现响应式设计
- 集成中国传统风格

## 6. 与现有功能集成

### 6.1 人员管理集成

- 在人员编辑页面添加宗族成员设置
- 在人员详情页面展示宗族信息
- 支持从人员列表快速添加到宗族

### 6.2 权限系统集成

- 支持基于角色的权限控制
- 支持宗族管理员权限
- 支持分支管理员权限

### 6.3 搜索功能集成

- 支持搜索宗族和成员
- 支持高级搜索选项
- 支持筛选和排序

## 7. 性能优化

- 实现数据缓存
- 优化数据库查询
- 实现分页加载
- 优化组织结构图渲染

## 8. 安全考虑

- 实现输入验证
- 防止SQL注入
- 实现权限控制
- 保护敏感数据

## 9. 测试计划

### 9.1 单元测试

- 测试数据模型
- 测试业务逻辑
- 测试数据访问层

### 9.2 集成测试

- 测试与现有功能的集成
- 测试权限系统
- 测试搜索功能

### 9.3 系统测试

- 测试完整的宗族管理流程
- 测试组织结构展示
- 测试性能和安全性

## 10. 部署计划

### 10.1 数据库迁移

- 创建必要的数据库表
- 实现数据迁移脚本
- 支持回滚功能

### 10.2 模块部署

- 将模块文件复制到相应目录
- 运行数据库迁移
- 配置权限
- 测试功能

## 11. 后续扩展

- 支持宗族活动管理
- 支持宗族文件管理
- 支持宗族统计功能
- 支持宗族论坛功能

## 12. 技术栈

- PHP 7.3+
- MySQL/PostgreSQL/SQLite
- webtrees 2.2.4
- 遵循PSR标准
- 使用现有的模块化架构
